#!/usr/bin/env ruby

require File.expand_path("../../config/environment", __FILE__)

sd_editions = SpecialistDocumentEdition.where(:document_type.ne => 'manual')

puts "\n## SpecialistDocumentEditions"
print "* With non-manual document type: "
p sd_editions.count
print "* With manual document type: "
p SpecialistDocumentEdition.where(document_type: 'manual').count

document_ids = Set.new(sd_editions.only(:document_id).map(&:document_id))
candidate_mr_editions = ManualRecord::Edition.only(:document_ids, :manual_record_id).where(:document_ids.in => document_ids)

mr_editions_with_only_non_manual_sd_editions = candidate_mr_editions.select do |e|
  Set.new(e.document_ids) <= document_ids
end
mr_editions_with_mixed_type_sd_editions = candidate_mr_editions - mr_editions_with_only_non_manual_sd_editions

puts "\n## ManualRecord::Editions"
print "* With mixed (manual vs non-manual) document types: "
p mr_editions_with_mixed_type_sd_editions.map(&:id).map(&:to_s)
print "* With only non-manual document types: "
p mr_editions_with_only_non_manual_sd_editions.map(&:id).map(&:to_s)

mr_edition_ids = Set.new(mr_editions_with_only_non_manual_sd_editions.map(&:id))
manual_record_ids = Set.new(mr_editions_with_only_non_manual_sd_editions.map(&:manual_record_id))
candidate_manual_records = ManualRecord.find(manual_record_ids.to_a)

manual_records_with_only_non_manual_mr_editions = candidate_manual_records.select do |mr|
  Set.new(mr.editions.map(&:id)) <= Set.new(mr_edition_ids)
end
manual_records_with_mixed_type_mr_editions = candidate_manual_records - manual_records_with_only_non_manual_mr_editions

puts "\n## ManualRecords"
print "* With mixed (manual vs non-manual) document types: "
p manual_records_with_mixed_type_mr_editions.map(&:id).map(&:to_s)
print "* With only non-manual document types: "
p manual_records_with_only_non_manual_mr_editions.map(&:id).map(&:to_s)
